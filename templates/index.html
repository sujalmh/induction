<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Injection Challenge</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body
    class="bg-gray-900 text-white flex items-center justify-center min-h-screen"
  >
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --- Main App Component (Router) ---
      const App = () => {
        const [page, setPage] = useState("challenge"); // challengeLogin, challenge, adminLogin, adminPanel

        const renderPage = () => {
          switch (page) {
            case "challenge":
              return <ChallengePage setPage={setPage} />;
            case "adminLogin":
              return <AdminLoginPage setPage={setPage} />;
            case "adminPanel":
              return <AdminPanelPage setPage={setPage} />;
            case "challengeLogin":
            default:
              return <ChallengeLoginPage setPage={setPage} />;
          }
        };

        return (
          <div className="container mx-auto p-2 sm:p-4 max-w-2xl w-full">
            {renderPage()}
          </div>
        );
      };

      // --- Helper Components ---
      const Card = ({ children, className }) => (
        <div
          className={`bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4 sm:p-6 md:p-8 ${className}`}
        >
          {children}
        </div>
      );

      const Title = ({ children, as = "h1" }) => {
        const Tag = as;
        return (
          <Tag className="text-xl sm:text-2xl md:text-3xl font-bold text-center text-cyan-400 mb-2">
            {children}
          </Tag>
        );
      };

      const Subtitle = ({ children }) => (
        <p className="text-center text-gray-400 mb-6">{children}</p>
      );

      const Input = (props) => (
        <input
          {...props}
          className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-md focus:ring-2 focus:ring-cyan-500 focus:outline-none transition"
        />
      );

      const Button = ({ children, ...props }) => (
        <button
          {...props}
          className="w-full px-4 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-bold rounded-md focus:ring-2 focus:ring-cyan-500 focus:outline-none transition disabled:bg-gray-500 disabled:cursor-not-allowed"
        >
          {children}
        </button>
      );

      const Alert = ({ message, type = "error" }) => {
        if (!message) return null;
        const colors = {
          error: "bg-red-900 border-red-700 text-red-300",
          success: "bg-green-900 border-green-700 text-green-300",
        };
        return (
          <div className={`p-4 mt-4 rounded-md border ${colors[type]}`}>
            {message}
          </div>
        );
      };

      // --- Page Components ---

      const AdminLoginPage = ({ setPage }) => {
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError("");
          setLoading(true);
          try {
            const res = await fetch("/api/admin/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            const data = await res.json();
            if (data.success) {
              setPage("adminPanel");
            } else {
              setError(data.message || "Login failed.");
            }
          } catch (err) {
            setError("An unexpected error occurred.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <Card>
            <Title>Admin Login</Title>
            <Subtitle>
              Enter the admin password to configure the challenge.
            </Subtitle>
            <form onSubmit={handleSubmit} className="space-y-4">
              <Input
                type="password"
                placeholder="Admin Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
              <Button type="submit" disabled={loading}>
                {loading ? "Logging in..." : "Login"}
              </Button>
            </form>
            <Alert message={error} />
            <button
              onClick={() => setPage("challengeLogin")}
              className="text-cyan-400 hover:underline text-center w-full mt-4"
            >
              Back to Challenge
            </button>
          </Card>
        );
      };

      const AdminPanelPage = ({ setPage }) => {
        const [secret, setSecret] = useState("");
        const [password, setPassword] = useState("");
        const [message, setMessage] = useState("");
        const [loading, setLoading] = useState(false);

        const handleSave = async (e) => {
          e.preventDefault();
          setMessage("");
          setLoading(true);
          try {
            const res = await fetch("/api/admin/config", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ secret, password }),
            });
            const data = await res.json();
            if (data.success) {
              setMessage(data.message);
              setSecret("");
              setPassword("");
            }
          } catch (err) {
            setMessage("An error occurred.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <Card>
            <Title>Admin Configuration</Title>
            <Subtitle>
              Set a new secret and password for the challenge.
            </Subtitle>
            <form onSubmit={handleSave} className="space-y-4">
              <div>
                <label className="block mb-1 text-sm text-gray-400">
                  New Secret Key
                </label>
                <Input
                  type="text"
                  placeholder="Enter new secret"
                  value={secret}
                  onChange={(e) => setSecret(e.target.value)}
                />
              </div>
              <div>
                <label className="block mb-1 text-sm text-gray-400">
                  New Challenge Password
                </label>
                <Input
                  type="password"
                  placeholder="Enter new password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                />
              </div>
              <Button type="submit" disabled={loading}>
                {loading ? "Saving..." : "Save Configuration"}
              </Button>
            </form>
            <Alert
              message={message}
              type={message.includes("error") ? "error" : "success"}
            />
            <button
              onClick={() => setPage("challengeLogin")}
              className="text-cyan-400 hover:underline text-center w-full mt-4"
            >
              Logout & Go to Challenge
            </button>
          </Card>
        );
      };

      const ChallengeLoginPage = ({ setPage }) => {
        const [password, setPassword] = useState("");
        const [error, setError] = useState("");
        const [loading, setLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError("");
          setLoading(true);
          try {
            const res = await fetch("/api/challenge/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ password }),
            });
            const data = await res.json();
            if (data.success) {
              setPage("challenge");
            } else {
              setError(data.message || "Access denied.");
            }
          } catch (err) {
            setError("An unexpected error occurred.");
          } finally {
            setLoading(false);
          }
        };
        return (
          <Card>
            <Title>Prompt Injection Challenge</Title>
            <Subtitle>Enter the password to begin.</Subtitle>
            <form onSubmit={handleSubmit} className="space-y-4">
              <Input
                type="password"
                placeholder="Challenge Password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
              <Button type="submit" disabled={loading}>
                {loading ? "Verifying..." : "Enter Challenge"}
              </Button>
            </form>
            <Alert message={error} />
            <div className="text-center mt-6">
              <button
                onClick={() => setPage("adminLogin")}
                className="text-sm text-gray-500 hover:text-cyan-400 transition"
              >
                Admin Login
              </button>
            </div>
          </Card>
        );
      };

      const ChallengePage = ({ setPage }) => {
        const [prompt, setPrompt] = useState("");
        const [aiResponse, setAiResponse] = useState(
          "AI is waiting for your prompt..."
        );
        const [leakedSecret, setLeakedSecret] = useState("");
        const [verifyMessage, setVerifyMessage] = useState("");
        const [verifyMessageType, setVerifyMessageType] = useState("error");
        const [promptLoading, setPromptLoading] = useState(false);
        const [verifyLoading, setVerifyLoading] = useState(false);

        const handlePromptSubmit = async (e) => {
          e.preventDefault();
          setAiResponse("");
          setPromptLoading(true);
          try {
            const res = await fetch("/api/challenge/prompt", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ prompt }),
            });
            const data = await res.json();
            setAiResponse(data.response || "No response from AI.");
          } catch (err) {
            setAiResponse("Error communicating with AI.");
          } finally {
            setPromptLoading(false);
          }
        };

        const handleVerifySubmit = async (e) => {
          e.preventDefault();
          setVerifyMessage("");
          setVerifyLoading(true);
          try {
            const res = await fetch("/api/challenge/verify", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ secret: leakedSecret }),
            });
            const data = await res.json();
            setVerifyMessage(data.message);
            setVerifyMessageType(data.success ? "success" : "error");
          } catch (err) {
            setVerifyMessage("Error verifying secret.");
            setVerifyMessageType("error");
          } finally {
            setVerifyLoading(false);
          }
        };

        return (
          <Card className="space-y-8">
            <div>
              <Title as="h2">The Challenge</Title>
              <Subtitle>Trick the AI into revealing its secret key.</Subtitle>

              <div className="bg-gray-900 p-4 rounded-lg border border-gray-700 min-h-[80px]">
                <p className="text-gray-300 font-mono whitespace-pre-wrap">
                  {aiResponse}
                </p>
              </div>

              <form
                onSubmit={handlePromptSubmit}
                className="mt-4 flex flex-col sm:flex-row gap-2"
              >
                <Input
                  type="text"
                  placeholder="Your prompt to the AI..."
                  value={prompt}
                  onChange={(e) => setPrompt(e.target.value)}
                />
                <Button
                  type="submit"
                  className="sm:w-auto"
                  disabled={promptLoading}
                >
                  {promptLoading ? "Thinking..." : "Send"}
                </Button>
              </form>
            </div>

            <div className="border-t border-gray-700 pt-8">
              <Title as="h2">Verify Secret</Title>
              <Subtitle>
                Once you have the secret, enter it below to win.
              </Subtitle>
              <form
                onSubmit={handleVerifySubmit}
                className="flex flex-col sm:flex-row gap-2"
              >
                <Input
                  type="text"
                  placeholder="Paste the leaked secret here"
                  value={leakedSecret}
                  onChange={(e) => setLeakedSecret(e.target.value)}
                />
                <Button
                  type="submit"
                  className="sm:w-auto"
                  disabled={verifyLoading}
                >
                  {verifyLoading ? "Checking..." : "Verify"}
                </Button>
              </form>
              <Alert message={verifyMessage} type={verifyMessageType} />
            </div>
            <button
              onClick={() => setPage("challengeLogin")}
              className="text-cyan-400 hover:underline text-center w-full mt-4"
            >
              Exit Challenge
            </button>
          </Card>
        );
      };

      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
